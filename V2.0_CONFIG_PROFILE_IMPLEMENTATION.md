# v2.0 Configuration Profile Implementation Guide

## Overview

Version 2.0 will introduce **Configuration Profile support** for all wrapper settings, allowing you to centrally manage configuration via Jamf Pro without modifying or redeploying the script.

## Benefits

- **Central Management**: Change settings for all Macs from Jamf Pro
- **Department-Specific Configs**: Deploy different settings to different groups
- **Instant Updates**: Changes take effect on next policy run (no package rebuild)
- **Override Flexibility**: Managed preferences override script defaults
- **Audit Trail**: Configuration changes tracked in Jamf change log

---

## Architecture

### Preference Domain

```
com.macjediwizard.eraseinstall.config
```

### Loading Priority

The wrapper script reads settings in this order:

1. **Managed Preferences** (Configuration Profile) - highest priority
2. **Local Preferences** (user defaults write)
3. **Script Defaults** (hardcoded in User Configuration Section) - fallback

### How It Works

```bash
# Example: Load INSTALLER_OS setting with fallback
INSTALLER_OS=$(defaults read /Library/Managed\ Preferences/com.macjediwizard.eraseinstall.config INSTALLER_OS 2>/dev/null || \
               defaults read com.macjediwizard.eraseinstall.config INSTALLER_OS 2>/dev/null || \
               echo "15")
```

---

## Code Implementation

### New Function: load_config_with_fallback()

This function will be added to the wrapper script to load all settings:

```bash
#######################################
# Load configuration with managed preference support
# Globals:
#   All configuration variables
# Arguments:
#   None
# Returns:
#   None (sets global variables)
#######################################
load_config_with_fallback() {
    local managed_prefs="/Library/Managed Preferences/com.macjediwizard.eraseinstall.config"
    local local_prefs="com.macjediwizard.eraseinstall.config"

    # Helper function to read preference with fallback
    read_pref() {
        local key="$1"
        local default_value="$2"
        local value=""

        # Try managed preferences first (Configuration Profile)
        if [ -f "${managed_prefs}.plist" ]; then
            value=$(defaults read "$managed_prefs" "$key" 2>/dev/null)
        fi

        # If not found, try local preferences
        if [ -z "$value" ]; then
            value=$(defaults read "$local_prefs" "$key" 2>/dev/null)
        fi

        # If still not found, use default
        if [ -z "$value" ]; then
            value="$default_value"
        fi

        echo "$value"
    }

    # Load all configuration settings
    INSTALLER_OS=$(read_pref "INSTALLER_OS" "15")
    MAX_DEFERS=$(read_pref "MAX_DEFERS" "3")
    MAX_ABORTS=$(read_pref "MAX_ABORTS" "3")
    FORCE_TIMEOUT_SECONDS=$(read_pref "FORCE_TIMEOUT_SECONDS" "259200")

    # File paths
    PLIST=$(read_pref "PLIST" "/Library/Preferences/com.macjediwizard.eraseinstall.plist")
    SCRIPT_PATH=$(read_pref "SCRIPT_PATH" "/Library/Management/erase-install/erase-install.sh")
    DIALOG_BIN=$(read_pref "DIALOG_BIN" "/Library/Management/erase-install/Dialog.app/Contents/MacOS/Dialog")

    # Testing and debug
    TEST_MODE=$(read_pref "TEST_MODE" "false")
    SKIP_OS_VERSION_CHECK=$(read_pref "SKIP_OS_VERSION_CHECK" "false")
    DEBUG_MODE=$(read_pref "DEBUG_MODE" "false")
    AUTO_INSTALL_DEPENDENCIES=$(read_pref "AUTO_INSTALL_DEPENDENCIES" "true")

    # Logging
    MAX_LOG_SIZE_MB=$(read_pref "MAX_LOG_SIZE_MB" "10")
    MAX_LOG_FILES=$(read_pref "MAX_LOG_FILES" "5")

    # Dialog appearance
    DIALOG_TITLE=$(read_pref "DIALOG_TITLE" "macOS Upgrade Required")
    DIALOG_MESSAGE=$(read_pref "DIALOG_MESSAGE" "Please install macOS ${INSTALLER_OS}. Select an action:")
    DIALOG_INSTALL_NOW_TEXT=$(read_pref "DIALOG_INSTALL_NOW_TEXT" "Install Now")
    DIALOG_SCHEDULE_TODAY_TEXT=$(read_pref "DIALOG_SCHEDULE_TODAY_TEXT" "Schedule Today")
    DIALOG_DEFER_TEXT=$(read_pref "DIALOG_DEFER_TEXT" "Defer 24 Hours")
    DIALOG_DEFER_TEXT_TEST_MODE=$(read_pref "DIALOG_DEFER_TEXT_TEST_MODE" "Defer 5 Minutes (TEST MODE)")
    ABORT_BUTTON_TEXT=$(read_pref "ABORT_BUTTON_TEXT" "Abort (Emergency)")
    DIALOG_ICON=$(read_pref "DIALOG_ICON" "SF=gear")
    DIALOG_POSITION=$(read_pref "DIALOG_POSITION" "topright")

    # Pre-authentication notice
    SHOW_AUTH_NOTICE=$(read_pref "SHOW_AUTH_NOTICE" "true")
    AUTH_NOTICE_TITLE=$(read_pref "AUTH_NOTICE_TITLE" "Admin Access Required")
    AUTH_NOTICE_MESSAGE=$(read_pref "AUTH_NOTICE_MESSAGE" "You will be prompted for admin credentials to begin the macOS upgrade process. If you're a standard user, please obtain temporary admin privileges via Jamf Connect or Self Service before clicking Continue.")
    AUTH_NOTICE_BUTTON=$(read_pref "AUTH_NOTICE_BUTTON" "I'm Ready to Continue")
    AUTH_NOTICE_TIMEOUT=$(read_pref "AUTH_NOTICE_TIMEOUT" "60")
    AUTH_NOTICE_ICON=$(read_pref "AUTH_NOTICE_ICON" "SF=lock.shield")

    # Log configuration source
    if [ -f "${managed_prefs}.plist" ]; then
        log_info "Configuration loaded from managed preferences (Configuration Profile)"
    else
        log_info "Configuration loaded from script defaults (no Configuration Profile deployed)"
    fi
}
```

### Integration Point

The script would call this function early in execution:

```bash
# Early in main() function, before any other logic
load_config_with_fallback

log_info "=== Configuration Summary ==="
log_info "Target macOS Version: ${INSTALLER_OS}"
log_info "Max Deferrals: ${MAX_DEFERS}"
log_info "Max Aborts: ${MAX_ABORTS}"
log_info "Test Mode: ${TEST_MODE}"
log_info "Debug Mode: ${DEBUG_MODE}"
```

---

## Jamf Pro Configuration Profile Setup

### Step 1: Create Custom Settings Profile

1. Navigate to: **Computers → Configuration Profiles → New**
2. Set **General** settings:
   - Display Name: `macOS Upgrade Wrapper Configuration`
   - Distribution Method: `Install Automatically`
   - Level: `Computer Level`

### Step 2: Add Application & Custom Settings Payload

1. Click **Application & Custom Settings**
2. Click **Configure**
3. Upload the `com.macjediwizard.eraseinstall.config.example.plist` file
4. Or click **Add** to create custom preferences:

```
Preference Domain: com.macjediwizard.eraseinstall.config

Custom Preferences:
  INSTALLER_OS (string): 15
  MAX_DEFERS (integer): 3
  MAX_ABORTS (integer): 3
  FORCE_TIMEOUT_SECONDS (integer): 259200
  TEST_MODE (boolean): false
  DEBUG_MODE (boolean): false
  ... (all settings from example plist)
```

### Step 3: Scope the Profile

**Target Computers:**
- Smart Group: "macOS Needs Upgrade to 15"

**Exclusions:**
- Smart Group: "macOS Already at Version 15"

### Step 4: Verify Deployment

On a test Mac, check if the profile is installed:

```bash
# Check if managed preferences exist
sudo ls -la "/Library/Managed Preferences/"

# Read configuration from managed prefs
sudo defaults read /Library/Managed\ Preferences/com.macjediwizard.eraseinstall.config

# Verify specific setting
sudo defaults read /Library/Managed\ Preferences/com.macjediwizard.eraseinstall.config INSTALLER_OS
```

---

## Example Use Cases

### Use Case 1: Different Settings Per Department

**IT Department (Early Adopters)**
- Profile: `macOS Upgrade Config - IT`
- Settings:
  - `MAX_DEFERS: 1` (aggressive enforcement)
  - `FORCE_TIMEOUT_SECONDS: 86400` (24 hours)
  - `DEBUG_MODE: true` (detailed logging)

**Finance Department (Conservative)**
- Profile: `macOS Upgrade Config - Finance`
- Settings:
  - `MAX_DEFERS: 5` (more flexibility)
  - `FORCE_TIMEOUT_SECONDS: 604800` (7 days)
  - `SHOW_AUTH_NOTICE: true` (extra preparation time)

### Use Case 2: Test Mode for QA Team

**QA Testing Group**
- Profile: `macOS Upgrade Config - QA`
- Settings:
  - `TEST_MODE: true`
  - `SKIP_OS_VERSION_CHECK: true`
  - `MAX_DEFERS: 99` (unlimited testing)
  - `DIALOG_TITLE: "[QA TEST] macOS Upgrade"`

### Use Case 3: Change Settings Organization-Wide

**Scenario:** Need to reduce deferral limit from 3 to 2 for all users

**Without Config Profiles (v1.x):**
1. Edit script file
2. Rebuild package
3. Redeploy to all Macs
4. Wait for policy execution
5. Time: Hours to days

**With Config Profiles (v2.0):**
1. Edit Configuration Profile in Jamf
2. Change `MAX_DEFERS: 2`
3. Save
4. Macs receive update on next check-in
5. Time: Minutes

---

## Migration from v1.7.x to v2.0

### Option 1: Keep Current Settings (No Action Required)

- Deploy v2.0 wrapper script
- Don't deploy Configuration Profile
- Script uses hardcoded defaults (identical to v1.7.x behavior)

### Option 2: Migrate to Configuration Profile Management

1. **Document Current Settings**
   ```bash
   # Extract current settings from deployed script
   grep -A 50 "User Configuration Section" /Library/Management/erase-install/erase-install-defer-wrapper.sh
   ```

2. **Create Configuration Profile**
   - Use `com.macjediwizard.eraseinstall.config.example.plist` as template
   - Update values to match your current script settings
   - Deploy to test group first

3. **Deploy v2.0 Script**
   - Use GitHub deployment method (same as v1.7.x)
   - Script will automatically detect and use Configuration Profile

4. **Verify**
   ```bash
   # Check wrapper log for configuration source
   tail -n 100 /var/log/erase-install-wrapper.log | grep "Configuration loaded"
   ```

### Option 3: Hybrid Approach

- Deploy Configuration Profile with only changed settings
- Script uses Configuration Profile for those keys
- Script falls back to defaults for missing keys
- Allows gradual migration

---

## Testing Configuration Profile

### Test Script

Save this as `/tmp/test-config-profile.sh`:

```bash
#!/bin/bash

echo "=== Configuration Profile Test ==="
echo ""

# Check if managed preferences exist
if [ -f "/Library/Managed Preferences/com.macjediwizard.eraseinstall.config.plist" ]; then
    echo "✅ Managed preferences found"
    echo ""
    echo "=== All Managed Settings ==="
    sudo defaults read /Library/Managed\ Preferences/com.macjediwizard.eraseinstall.config
    echo ""
else
    echo "❌ No managed preferences found"
    echo "Configuration Profile may not be deployed or installed"
    exit 1
fi

# Test specific settings
echo "=== Testing Key Settings ==="
echo "INSTALLER_OS: $(sudo defaults read /Library/Managed\ Preferences/com.macjediwizard.eraseinstall.config INSTALLER_OS 2>/dev/null || echo 'Not set')"
echo "MAX_DEFERS: $(sudo defaults read /Library/Managed\ Preferences/com.macjediwizard.eraseinstall.config MAX_DEFERS 2>/dev/null || echo 'Not set')"
echo "TEST_MODE: $(sudo defaults read /Library/Managed\ Preferences/com.macjediwizard.eraseinstall.config TEST_MODE 2>/dev/null || echo 'Not set')"
echo "DIALOG_TITLE: $(sudo defaults read /Library/Managed\ Preferences/com.macjediwizard.eraseinstall.config DIALOG_TITLE 2>/dev/null || echo 'Not set')"
echo ""

# Check wrapper log for configuration loading
if [ -f "/var/log/erase-install-wrapper.log" ]; then
    echo "=== Last Configuration Load from Wrapper Log ==="
    grep "Configuration loaded" /var/log/erase-install-wrapper.log | tail -1
fi

echo ""
echo "=== Test Complete ==="
```

Run test:
```bash
sudo bash /tmp/test-config-profile.sh
```

---

## Troubleshooting

### Configuration Profile Not Applied

**Check profile installation:**
```bash
sudo profiles list | grep macjediwizard
```

**Check managed preferences folder:**
```bash
sudo ls -la /Library/Managed\ Preferences/ | grep macjediwizard
```

**Re-install profile:**
```bash
sudo jamf policy -id <profile_policy_id>
```

### Settings Not Taking Effect

**Check wrapper log:**
```bash
tail -50 /var/log/erase-install-wrapper.log | grep -i "configuration"
```

**Verify preference domain:**
```bash
# Should match: com.macjediwizard.eraseinstall.config
sudo defaults domains | grep macjediwizard
```

### Wrong Values Being Used

**Check all preference sources:**
```bash
# Managed (highest priority)
sudo defaults read /Library/Managed\ Preferences/com.macjediwizard.eraseinstall.config INSTALLER_OS

# Local (medium priority)
defaults read com.macjediwizard.eraseinstall.config INSTALLER_OS

# If both fail, script uses hardcoded default
```

---

## Configuration Profile Template for Jamf Pro

Complete XML template ready for Jamf upload:

See: `com.macjediwizard.eraseinstall.config.example.plist`

---

## Backwards Compatibility

**v2.0 is fully backwards compatible with v1.7.x:**

- If no Configuration Profile deployed → uses hardcoded defaults (v1.7.x behavior)
- If Configuration Profile deployed → uses managed settings (v2.0 behavior)
- Mixed deployments supported (some Macs with profile, some without)
- No breaking changes to existing workflows

---

## v2.0 Release Roadmap

### Phase 1: Foundation (Weeks 1-2)
- [ ] Implement `load_config_with_fallback()` function
- [ ] Replace hardcoded variables with config loading
- [ ] Add configuration source logging
- [ ] Create test suite for preference loading

### Phase 2: Documentation (Week 3)
- [ ] Create Configuration Profile template
- [ ] Write Jamf setup guide
- [ ] Document migration from v1.7.x
- [ ] Create troubleshooting guide

### Phase 3: Testing (Week 4)
- [ ] Test with Configuration Profile
- [ ] Test without Configuration Profile (fallback)
- [ ] Test mixed deployments
- [ ] Test per-department configurations

### Phase 4: Release (Week 5)
- [ ] Update README with v2.0 features
- [ ] Update CHANGELOG
- [ ] Create release notes
- [ ] Tag v2.0.0 in GitHub
- [ ] Announce release

---

## Questions or Feedback?

This v2.0 implementation plan is designed to provide maximum flexibility while maintaining backwards compatibility. If you have suggestions or want to prioritize specific features, please open a GitHub issue.

---

**Made with ❤️ by MacJediWizard Consulting, Inc.**
