# v2.0 Testing Checklist

## Overview

v2.0 introduces JSON-based configuration management. This checklist ensures all functionality works correctly before merging to `main`.

---

## üåø Branch Information

- **Development Branch**: `v2.0-dev`
- **Main Branch**: `main` (v1.7.2)
- **Merge Status**: ‚è≥ Pending testing

---

## üì¶ What's New in v2.0

### Core Functionality
- [x] `load_json_config()` function implemented
- [x] Three-tier configuration priority (Managed > Local > Script Defaults)
- [x] JSON validation with plutil
- [x] Backwards compatibility with v1.7.x
- [x] All 50+ User Configuration Section settings supported

### Documentation
- [x] Complete JSON template (`com.macjediwizard.eraseinstall.config.json`)
- [x] Technical implementation guide (`V2.0_JSON_CONFIG_IMPLEMENTATION.md`)
- [x] Quick start guide (`JAMF_CONFIG_PROFILE_QUICK_START.md`)
- [x] README updated with v2.0 features
- [x] Test script (`test-json-config.sh`)

### Code Quality
- [x] Bash syntax validation passed
- [x] Version updated to 2.0.0
- [x] Changelog updated
- [ ] Functional testing (see below)

---

## ‚úÖ Pre-Merge Testing Checklist

### Test 1: No JSON Configuration (Backwards Compatibility)
**Goal**: Verify script works exactly like v1.7.2 when no JSON present

- [ ] Run wrapper without any JSON files
- [ ] Verify uses hardcoded defaults from User Configuration Section
- [ ] Verify `INSTALLER_OS=15` (default)
- [ ] Verify `MAX_DEFERS=3` (default)
- [ ] Verify `TEST_MODE=false` (default)
- [ ] Check log shows: "Configuration source: Script Defaults"

**Command**:
```bash
sudo /Library/Management/erase-install/erase-install-defer-wrapper.sh
```

**Expected Log Output**:
```
[CONFIG] No JSON configuration found, using script defaults from User Configuration Section
[INFO] Starting erase-install wrapper script v2.0.0
[INFO] Configuration source: Script Defaults
```

---

### Test 2: Local JSON Configuration
**Goal**: Verify script loads settings from local JSON

- [ ] Create local JSON at `/Library/Preferences/com.macjediwizard.eraseinstall.config.json`
- [ ] Set `INSTALLER_OS=16` in JSON
- [ ] Set `MAX_DEFERS=5` in JSON
- [ ] Set `TEST_MODE=true` in JSON
- [ ] Run wrapper
- [ ] Verify settings from JSON are used (not defaults)
- [ ] Check log shows: "Configuration source: Local JSON"

**Setup**:
```bash
sudo cp com.macjediwizard.eraseinstall.config.json /Library/Preferences/
```

**Validation**:
```bash
# Check JSON is valid
plutil -lint /Library/Preferences/com.macjediwizard.eraseinstall.config.json

# Run wrapper and check config loading
sudo /Library/Management/erase-install/erase-install-defer-wrapper.sh 2>&1 | head -30
```

**Expected Log Output**:
```
[CONFIG] Found local JSON configuration: /Library/Preferences/com.macjediwizard.eraseinstall.config.json
[CONFIG] JSON syntax validated successfully
[CONFIG] Configuration loaded from: local configuration
[CONFIG] Target macOS Version: 16
[CONFIG] Max Deferrals: 5
[CONFIG] Test Mode: true
```

---

### Test 3: Managed JSON Configuration (Jamf Simulation)
**Goal**: Verify managed JSON takes priority over local JSON

- [ ] Keep local JSON from Test 2
- [ ] Create managed JSON at `/Library/Managed Preferences/com.macjediwizard.eraseinstall.config.json`
- [ ] Set `INSTALLER_OS=14` in managed JSON (different from local)
- [ ] Set `MAX_DEFERS=2` in managed JSON
- [ ] Run wrapper
- [ ] Verify managed settings used (not local or defaults)
- [ ] Check log shows: "Configuration source: Managed JSON (Jamf)"

**Setup**:
```bash
sudo mkdir -p "/Library/Managed Preferences"
sudo cp com.macjediwizard.eraseinstall.config.json "/Library/Managed Preferences/"

# Edit managed JSON to have different values
sudo plutil -replace core_settings.INSTALLER_OS -string "14" "/Library/Managed Preferences/com.macjediwizard.eraseinstall.config.json"
sudo plutil -replace core_settings.MAX_DEFERS -integer 2 "/Library/Managed Preferences/com.macjediwizard.eraseinstall.config.json"
```

**Expected Log Output**:
```
[CONFIG] Found managed JSON configuration: /Library/Managed Preferences/com.macjediwizard.eraseinstall.config.json
[CONFIG] Configuration loaded from: managed configuration (Jamf)
[CONFIG] Target macOS Version: 14
[CONFIG] Max Deferrals: 2
```

---

### Test 4: Invalid JSON (Error Handling)
**Goal**: Verify script falls back to defaults if JSON is invalid

- [ ] Create invalid JSON (syntax error)
- [ ] Run wrapper
- [ ] Verify error logged
- [ ] Verify falls back to script defaults
- [ ] Script continues to function normally

**Setup**:
```bash
# Create invalid JSON
sudo bash -c 'cat > "/Library/Managed Preferences/com.macjediwizard.eraseinstall.config.json" <<EOF
{
  "core_settings": {
    "INSTALLER_OS": "15"
  // Missing closing brace - invalid
EOF
'
```

**Validation**:
```bash
# Verify JSON is invalid
plutil -lint "/Library/Managed Preferences/com.macjediwizard.eraseinstall.config.json" || echo "Invalid as expected"

# Run wrapper
sudo /Library/Management/erase-install/erase-install-defer-wrapper.sh 2>&1 | head -30
```

**Expected Log Output**:
```
[CONFIG] Found managed JSON configuration: /Library/Managed Preferences/com.macjediwizard.eraseinstall.config.json
[CONFIG] ERROR: JSON syntax invalid in /Library/Managed Preferences/com.macjediwizard.eraseinstall.config.json - falling back to script defaults
[INFO] Starting erase-install wrapper script v2.0.0
[INFO] Configuration source: Script Defaults
```

---

### Test 5: Automated Test Script
**Goal**: Run comprehensive automated tests

- [ ] Run `test-json-config.sh`
- [ ] Verify all 4 test scenarios pass
- [ ] Review output for any unexpected behavior

**Command**:
```bash
cd /Users/willieg/Dropbox/GitHub/Jamf---Silent-macOS-Upgrade-Scheduler
sudo ./test-json-config.sh
```

---

### Test 6: Full Workflow Test with JSON Config
**Goal**: Verify complete upgrade workflow works with JSON configuration

- [ ] Deploy managed JSON with test settings:
  - `TEST_MODE=true`
  - `SKIP_OS_VERSION_CHECK=true`
  - `PREVENT_ALL_REBOOTS=true`
  - `MAX_DEFERS=1`
- [ ] Run wrapper
- [ ] Verify dialog appears with correct settings from JSON
- [ ] Test deferral (should be 5 minutes in test mode)
- [ ] Test scheduling
- [ ] Verify all workflows function normally

---

### Test 7: Jamf Configuration Profile Deployment (Optional)
**Goal**: Test actual Jamf deployment method

- [ ] Create Jamf Configuration Profile
- [ ] Add Files and Processes payload
- [ ] Upload JSON config file
- [ ] Set destination: `/Library/Managed Preferences/`
- [ ] Scope to test Mac
- [ ] Verify file deployed correctly
- [ ] Run wrapper
- [ ] Verify config loaded from Jamf-deployed JSON

---

## üêõ Known Issues to Watch For

- [ ] JSON parsing errors with special characters in strings
- [ ] File permissions issues with managed preferences
- [ ] Variable substitution not working (e.g., `{{INSTALLER_OS}}` in messages)
- [ ] Boolean values not converting correctly ("true" vs true)
- [ ] Integer values being read as strings
- [ ] Fallback logic not triggering when expected

---

## üìä Performance Checks

- [ ] Config loading adds < 1 second to startup time
- [ ] No impact on script execution when using defaults
- [ ] plutil commands execute without errors
- [ ] No memory leaks or hung processes

---

## üîí Security Checks

- [ ] JSON files have correct permissions (644)
- [ ] Managed preferences directory protected (root:wheel)
- [ ] No sensitive data in JSON config
- [ ] Input validation prevents injection attacks

---

## üìù Documentation Review

- [ ] README accurately describes v2.0 features
- [ ] Quick start guide is clear and complete
- [ ] Technical implementation guide matches actual code
- [ ] JSON template has all required settings
- [ ] Example configs are valid and useful

---

## ‚úÖ Merge Criteria

**Before merging `v2.0-dev` ‚Üí `main`, all of these must be true:**

- [ ] All functional tests pass (Tests 1-5 minimum)
- [ ] No regressions in v1.7.2 functionality
- [ ] JSON configuration loads correctly
- [ ] Fallback to defaults works
- [ ] Priority order correct (Managed > Local > Defaults)
- [ ] Invalid JSON handled gracefully
- [ ] Documentation is complete and accurate
- [ ] Test script runs successfully
- [ ] At least one full workflow test completed
- [ ] Bash syntax validation passes
- [ ] No critical bugs identified

---

## üöÄ Merge Process

Once all tests pass:

```bash
# Verify you're on v2.0-dev
git branch --show-current

# Final commit review
git log --oneline v2.0-dev ^main

# Switch to main
git checkout main

# Merge v2.0-dev
git merge v2.0-dev --no-ff -m "Merge v2.0.0: JSON Configuration Management"

# Tag release
git tag -a v2.0.0 -m "v2.0.0: JSON-based configuration management"

# Push to remote
git push origin main --tags
```

---

## üìã Post-Merge Tasks

- [ ] Create GitHub release for v2.0.0
- [ ] Upload JSON template to release assets
- [ ] Update GitHub README to show v2.0 as latest
- [ ] Announce v2.0 release with migration guide
- [ ] Archive v1.7.2 documentation
- [ ] Update any external documentation links

---

## üÜò Rollback Plan

If critical issues are found after merge:

```bash
# Revert merge
git revert -m 1 <merge-commit-hash>

# Or reset to v1.7.2
git reset --hard v1.7.2

# Force push (use with caution)
git push origin main --force
```

---

## üìû Support

If you encounter issues during testing:

1. Check logs in `/var/log/erase-install-wrapper.log`
2. Verify JSON syntax with `plutil -lint`
3. Review v2.0 implementation documentation
4. Check GitHub issues for similar problems

---

**Made with ‚ù§Ô∏è by MacJediWizard Consulting, Inc.**
