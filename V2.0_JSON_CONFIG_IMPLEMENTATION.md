# v2.0 JSON Configuration Implementation Guide

## Overview

Version 2.0 introduces **JSON-based configuration management** via Jamf Pro, allowing you to control all wrapper settings without modifying or redeploying the script.

## Why JSON?

- ✅ **Human-readable** - Easy to read and edit
- ✅ **Jamf-friendly** - Edit directly in Jamf's text interface
- ✅ **Version control** - Track changes in Jamf's audit log
- ✅ **Industry standard** - Familiar format for all admins
- ✅ **Structured** - Organized by category (dialogs, features, paths)

---

## Architecture

### Configuration File Location

```
/Library/Managed Preferences/com.macjediwizard.eraseinstall.config.json
```

### Loading Priority

1. **Custom JSON** (`--config=/path/to/file.json`) - highest priority (command-line override)
2. **Managed JSON** (Jamf Configuration Profile) - high priority
3. **Local JSON** (`/Library/Preferences/...`) - medium priority
4. **Script Defaults** (hardcoded in wrapper) - fallback

---

## Command-Line Parameters

v2.0 includes command-line parameters for testing, debugging, and custom deployments.

### Available Parameters

#### `--version`

Display script version information.

**Usage:**
```bash
sudo /Library/Management/erase-install/erase-install-defer-wrapper.sh --version
```

**Example Output:**
```
erase-install-defer-wrapper v2.0.0
JSON Configuration Management for macOS Upgrade Automation

GitHub: https://github.com/MacJediWizard/Jamf-Silent-macOS-Upgrade-Scheduler
Made with ❤️ by MacJediWizard Consulting, Inc.
```

#### `--help` or `-h`

Display help information and usage examples.

**Usage:**
```bash
sudo /Library/Management/erase-install/erase-install-defer-wrapper.sh --help
```

**Example Output:**
```
erase-install-defer-wrapper v2.0.0
JSON Configuration Management for macOS Upgrade Automation

Usage: ./erase-install-defer-wrapper.sh [OPTIONS]

Options:
  --show-config              Display current configuration and exit
  --config=/path/to/file     Use custom JSON configuration file
  --test-os-check            Skip OS version check (for testing)
  --version                  Display version information and exit
  --help, -h                 Display this help message and exit

Configuration Priority (Highest to Lowest):
  1. Custom JSON (--config parameter)
  2. Managed JSON (/Library/Managed Preferences/...)
  3. Local JSON (/Library/Preferences/...)
  4. Script Defaults

Examples:
  ./erase-install-defer-wrapper.sh --show-config
  ./erase-install-defer-wrapper.sh --config=/tmp/test-config.json
  ./erase-install-defer-wrapper.sh --config=/tmp/qa.json --test-os-check

Documentation: https://github.com/MacJediWizard/Jamf-Silent-macOS-Upgrade-Scheduler
```

#### `--show-config`

Display current configuration without running the script.

**Usage:**
```bash
sudo /Library/Management/erase-install/erase-install-defer-wrapper.sh --show-config
```

**Example Output:**
```
=== Current Configuration ===
Configuration Source: managed configuration (Jamf)

Core Settings:
  SCRIPT_VERSION: 2.0.0
  INSTALLER_OS: 15
  MAX_DEFERS: 3
  MAX_ABORTS: 3
  FORCE_TIMEOUT_SECONDS: 259200

Feature Toggles:
  TEST_MODE: false
  DEBUG_MODE: false
  SKIP_OS_VERSION_CHECK: false
  PREVENT_ALL_REBOOTS: false
  AUTO_INSTALL_DEPENDENCIES: true
```

#### `--config=/path/to/file.json`

Use a custom JSON configuration file (overrides managed and local configs).

**Usage:**
```bash
# Test with custom config
sudo /Library/Management/erase-install/erase-install-defer-wrapper.sh --config=/tmp/test-config.json

# QA testing with aggressive settings
sudo /Library/Management/erase-install/erase-install-defer-wrapper.sh --config=/Users/admin/qa-config.json
```

**Use Cases:**
- Testing configuration changes before deploying via Jamf
- Department-specific configs without using Jamf scopes
- One-off deployments with unique settings
- Development and QA environments

#### `--test-os-check`

Skip macOS version check (allows testing on any OS version).

**Usage:**
```bash
# Test on macOS 14 when targeting macOS 15
sudo /Library/Management/erase-install/erase-install-defer-wrapper.sh --test-os-check
```

**Use Cases:**
- Testing workflows on lower OS versions
- QA validation without meeting version requirements
- Development environments

### Combining Parameters

You can combine multiple parameters:

```bash
# Show config from custom file
sudo /Library/Management/erase-install/erase-install-defer-wrapper.sh --config=/tmp/test.json --show-config

# Run with custom config and skip OS check
sudo /Library/Management/erase-install/erase-install-defer-wrapper.sh --config=/tmp/qa.json --test-os-check
```

---

## Wrapper Script Integration

### New Function: load_json_config()

This function will be added to the wrapper script:

```bash
#######################################
# Load configuration from JSON file with fallback to defaults
# Globals:
#   All configuration variables
# Arguments:
#   None
# Returns:
#   0 on success, 1 if using defaults
#######################################
load_json_config() {
    local managed_json="/Library/Managed Preferences/com.macjediwizard.eraseinstall.config.json"
    local local_json="/Library/Preferences/com.macjediwizard.eraseinstall.config.json"
    local config_file=""
    local config_source="script defaults"
    local json_loaded=false

    # Check for custom config path (command-line override) - highest priority
    if [[ -n "$CUSTOM_CONFIG_PATH" ]]; then
        if [ -f "$CUSTOM_CONFIG_PATH" ]; then
            config_file="$CUSTOM_CONFIG_PATH"
            config_source="custom configuration (--config parameter)"
            json_loaded=true
            echo "[CONFIG] Using custom JSON configuration: $CUSTOM_CONFIG_PATH" >&2
        else
            echo "[CONFIG] ERROR: Custom config file not found: $CUSTOM_CONFIG_PATH" >&2
            echo "[CONFIG] Falling back to standard configuration search" >&2
        fi
    fi

    # Check for managed configuration (Jamf deployed)
    if [[ "$json_loaded" == "false" ]] && [ -f "$managed_json" ]; then
        config_file="$managed_json"
        config_source="managed configuration (Jamf)"
        json_loaded=true
        echo "[CONFIG] Found managed JSON configuration: $managed_json" >&2
    fi

    # Check for local configuration
    if [[ "$json_loaded" == "false" ]] && [ -f "$local_json" ]; then
        config_file="$local_json"
        config_source="local configuration"
        json_loaded=true
        echo "[CONFIG] Found local JSON configuration: $local_json" >&2
    fi

    # No JSON configuration found
    if [[ "$json_loaded" == "false" ]]; then
        echo "[CONFIG] No JSON configuration found, using script defaults from User Configuration Section" >&2
        return 1
    fi

    # Helper function to read JSON value with plutil
    read_json() {
        local json_path="$1"
        local default_value="$2"
        local value=""

        # Use plutil to extract value (native macOS tool, no dependencies)
        value=$(plutil -extract "$json_path" raw "$config_file" 2>/dev/null || echo "")

        # If extraction failed or empty, use default
        if [ -z "$value" ]; then
            echo "$default_value"
        else
            echo "$value"
        fi
    }

    # Load Core Settings
    INSTALLER_OS=$(read_json "core_settings.INSTALLER_OS" "15")
    MAX_DEFERS=$(read_json "core_settings.MAX_DEFERS" "3")
    FORCE_TIMEOUT_SECONDS=$(read_json "core_settings.FORCE_TIMEOUT_SECONDS" "259200")

    # Load File Paths
    PLIST=$(read_json "file_paths.PLIST" "/Library/Preferences/com.macjediwizard.eraseinstall.plist")
    SCRIPT_PATH=$(read_json "file_paths.SCRIPT_PATH" "/Library/Management/erase-install/erase-install.sh")
    DIALOG_BIN=$(read_json "file_paths.DIALOG_BIN" "/Library/Management/erase-install/Dialog.app/Contents/MacOS/Dialog")
    LAUNCHDAEMON_LABEL=$(read_json "file_paths.LAUNCHDAEMON_LABEL" "com.macjediwizard.eraseinstall.schedule")
    LAUNCHDAEMON_PATH=$(read_json "file_paths.LAUNCHDAEMON_PATH" "/Library/LaunchDaemons/${LAUNCHDAEMON_LABEL}.plist")

    # Load Feature Toggles
    TEST_MODE=$(read_json "feature_toggles.TEST_MODE" "false")
    PREVENT_ALL_REBOOTS=$(read_json "feature_toggles.PREVENT_ALL_REBOOTS" "false")
    SKIP_OS_VERSION_CHECK=$(read_json "feature_toggles.SKIP_OS_VERSION_CHECK" "false")
    AUTO_INSTALL_DEPENDENCIES=$(read_json "feature_toggles.AUTO_INSTALL_DEPENDENCIES" "true")
    DEBUG_MODE=$(read_json "feature_toggles.DEBUG_MODE" "false")

    # Load Logging Configuration
    MAX_LOG_SIZE_MB=$(read_json "logging.MAX_LOG_SIZE_MB" "10")
    MAX_LOG_FILES=$(read_json "logging.MAX_LOG_FILES" "5")

    # Load Main Dialog Settings
    DIALOG_TITLE=$(read_json "main_dialog.DIALOG_TITLE" "macOS Upgrade Required")
    DIALOG_TITLE_TEST_MODE=$(read_json "main_dialog.DIALOG_TITLE_TEST_MODE" "macOS Upgrade Required\n                (TEST MODE)")
    DIALOG_MESSAGE=$(read_json "main_dialog.DIALOG_MESSAGE" "Please install macOS ${INSTALLER_OS}. Select an action:")
    DIALOG_ICON=$(read_json "main_dialog.DIALOG_ICON" "SF=gear,weight=bold,size=128")
    DIALOG_POSITION=$(read_json "main_dialog.DIALOG_POSITION" "topright")
    DIALOG_HEIGHT=$(read_json "main_dialog.DIALOG_HEIGHT" "250")
    DIALOG_WIDTH=$(read_json "main_dialog.DIALOG_WIDTH" "650")
    DIALOG_MESSAGEFONT=$(read_json "main_dialog.DIALOG_MESSAGEFONT" "size=16")
    DIALOG_INSTALL_NOW_TEXT=$(read_json "main_dialog.DIALOG_INSTALL_NOW_TEXT" "Install Now")
    DIALOG_SCHEDULE_TODAY_TEXT=$(read_json "main_dialog.DIALOG_SCHEDULE_TODAY_TEXT" "Schedule Today")
    DIALOG_DEFER_TEXT=$(read_json "main_dialog.DIALOG_DEFER_TEXT" "Defer 24 Hours")
    DIALOG_DEFER_TEXT_TEST_MODE=$(read_json "main_dialog.DIALOG_DEFER_TEXT_TEST_MODE" "Defer 5 Minutes   (TEST MODE)")
    DIALOG_CONFIRM_TEXT=$(read_json "main_dialog.DIALOG_CONFIRM_TEXT" "Confirm")

    # Load Pre-installation Dialog Settings
    PREINSTALL_TITLE=$(read_json "preinstall_dialog.PREINSTALL_TITLE" "macOS Upgrade Starting")
    PREINSTALL_TITLE_TEST_MODE=$(read_json "preinstall_dialog.PREINSTALL_TITLE_TEST_MODE" "macOS Upgrade Starting\n                (TEST MODE)")
    PREINSTALL_MESSAGE=$(read_json "preinstall_dialog.PREINSTALL_MESSAGE" "Your scheduled macOS upgrade is ready to begin.\n\nThe upgrade will start automatically in 60 seconds, or click Continue to begin now.")
    PREINSTALL_PROGRESS_TEXT_MESSAGE=$(read_json "preinstall_dialog.PREINSTALL_PROGRESS_TEXT_MESSAGE" "Installation will begin in 60 seconds...")
    PREINSTALL_CONTINUE_TEXT=$(read_json "preinstall_dialog.PREINSTALL_CONTINUE_TEXT" "Continue Now")
    PREINSTALL_COUNTDOWN=$(read_json "preinstall_dialog.PREINSTALL_COUNTDOWN" "60")
    PREINSTALL_HEIGHT=$(read_json "preinstall_dialog.PREINSTALL_HEIGHT" "350")
    PREINSTALL_WIDTH=$(read_json "preinstall_dialog.PREINSTALL_WIDTH" "650")
    PREINSTALL_DIALOG_MESSAGEFONT=$(read_json "preinstall_dialog.PREINSTALL_DIALOG_MESSAGEFONT" "size=16")

    # Load Scheduled Dialog Settings
    SCHEDULED_TITLE=$(read_json "scheduled_dialog.SCHEDULED_TITLE" "macOS Upgrade Scheduled")
    SCHEDULED_TITLE_TEST_MODE=$(read_json "scheduled_dialog.SCHEDULED_TITLE_TEST_MODE" "macOS Upgrade Scheduled\n                (TEST MODE)")
    SCHEDULED_MESSAGE=$(read_json "scheduled_dialog.SCHEDULED_MESSAGE" "Your scheduled macOS upgrade is ready to begin.\n\nThe upgrade will start automatically in 60 seconds,\n\n or click Continue to begin now.")
    SCHEDULED_PROGRESS_TEXT_MESSAGE=$(read_json "scheduled_dialog.SCHEDULED_PROGRESS_TEXT_MESSAGE" "Installation will begin in 60 seconds.....")
    SCHEDULED_CONTINUE_TEXT=$(read_json "scheduled_dialog.SCHEDULED_CONTINUE_TEXT" "Continue Now")
    SCHEDULED_COUNTDOWN=$(read_json "scheduled_dialog.SCHEDULED_COUNTDOWN" "60")
    SCHEDULED_HEIGHT=$(read_json "scheduled_dialog.SCHEDULED_HEIGHT" "250")
    SCHEDULED_WIDTH=$(read_json "scheduled_dialog.SCHEDULED_WIDTH" "650")
    SCHEDULED_CONTINUE_HEIGHT=$(read_json "scheduled_dialog.SCHEDULED_CONTINUE_HEIGHT" "350")
    SCHEDULED_CONTINUE_WIDTH=$(read_json "scheduled_dialog.SCHEDULED_CONTINUE_WIDTH" "750")
    SCHEDULED_DIALOG_MESSAGEFONT=$(read_json "scheduled_dialog.SCHEDULED_DIALOG_MESSAGEFONT" "size=16")

    # Load Error Dialog Settings
    ERROR_DIALOG_TITLE=$(read_json "error_dialog.ERROR_DIALOG_TITLE" "Invalid Time")
    ERROR_DIALOG_MESSAGE=$(read_json "error_dialog.ERROR_DIALOG_MESSAGE" "The selected time is invalid.\nPlease select a valid time (00:00-23:59).")
    ERROR_DIALOG_ICON=$(read_json "error_dialog.ERROR_DIALOG_ICON" "SF=exclamationmark.triangle")
    ERROR_DIALOG_HEIGHT=$(read_json "error_dialog.ERROR_DIALOG_HEIGHT" "350")
    ERROR_DIALOG_WIDTH=$(read_json "error_dialog.ERROR_DIALOG_WIDTH" "650")
    ERROR_CONTINUE_TEXT=$(read_json "error_dialog.ERROR_CONTINUE_TEXT" "OK")

    # Load erase-install Options
    REBOOT_DELAY=$(read_json "erase_install_options.REBOOT_DELAY" "60")
    REINSTALL=$(read_json "erase_install_options.REINSTALL" "true")
    NO_FS=$(read_json "erase_install_options.NO_FS" "true")
    CHECK_POWER=$(read_json "erase_install_options.CHECK_POWER" "true")
    POWER_WAIT_LIMIT=$(read_json "erase_install_options.POWER_WAIT_LIMIT" "300")
    MIN_DRIVE_SPACE=$(read_json "erase_install_options.MIN_DRIVE_SPACE" "50")
    CLEANUP_AFTER_USE=$(read_json "erase_install_options.CLEANUP_AFTER_USE" "true")

    # Load Authentication Notice Settings
    SHOW_AUTH_NOTICE=$(read_json "auth_notice.SHOW_AUTH_NOTICE" "true")
    AUTH_NOTICE_TITLE=$(read_json "auth_notice.AUTH_NOTICE_TITLE" "Admin Access Required")
    AUTH_NOTICE_TITLE_TEST_MODE=$(read_json "auth_notice.AUTH_NOTICE_TITLE_TEST_MODE" "Admin Access Required\n            (TEST MODE)")
    AUTH_NOTICE_MESSAGE=$(read_json "auth_notice.AUTH_NOTICE_MESSAGE" "You will be prompted for admin credentials to complete the macOS upgrade.\n\nIf you do not have admin access, please use Jamf Connect or Self Service to elevate your permissions before continuing.")
    AUTH_NOTICE_BUTTON=$(read_json "auth_notice.AUTH_NOTICE_BUTTON" "I'm Ready to Continue")
    AUTH_NOTICE_TIMEOUT=$(read_json "auth_notice.AUTH_NOTICE_TIMEOUT" "0")
    AUTH_NOTICE_ICON=$(read_json "auth_notice.AUTH_NOTICE_ICON" "SF=lock.shield")
    AUTH_NOTICE_HEIGHT=$(read_json "auth_notice.AUTH_NOTICE_HEIGHT" "300")
    AUTH_NOTICE_WIDTH=$(read_json "auth_notice.AUTH_NOTICE_WIDTH" "750")

    # Load Abort Button Settings
    ENABLE_ABORT_BUTTON=$(read_json "abort_button.ENABLE_ABORT_BUTTON" "true")
    ABORT_BUTTON_TEXT=$(read_json "abort_button.ABORT_BUTTON_TEXT" "Abort (Emergency)")
    ABORT_DEFER_MINUTES=$(read_json "abort_button.ABORT_DEFER_MINUTES" "5")
    MAX_ABORTS=$(read_json "abort_button.MAX_ABORTS" "3")
    ABORT_COUNTDOWN=$(read_json "abort_button.ABORT_COUNTDOWN" "15")
    ABORT_HEIGHT=$(read_json "abort_button.ABORT_HEIGHT" "250")
    ABORT_WIDTH=$(read_json "abort_button.ABORT_WIDTH" "750")
    ABORT_ICON=$(read_json "abort_button.ABORT_ICON" "SF=exclamationmark.triangle")

    # Log configuration summary
    log_info "=== Configuration loaded from: $config_source ==="
    log_info "Target macOS Version: ${INSTALLER_OS}"
    log_info "Max Deferrals: ${MAX_DEFERS}"
    log_info "Max Aborts: ${MAX_ABORTS}"
    log_info "Test Mode: ${TEST_MODE}"
    log_info "Debug Mode: ${DEBUG_MODE}"

    return 0
}
```

### Integration in Main Script

```bash
# Early in main() function, replace User Configuration Section
main() {
    # Load configuration (JSON or defaults)
    load_json_config

    # Continue with rest of script...
}
```

---

## Configuration Validation

v2.0 includes built-in validation to prevent invalid configuration values from breaking the script.

### Validated Settings

The following settings are validated automatically:

**Numeric Values:**
- `INSTALLER_OS` - Must be a valid number (e.g., 14, 15, 16)
- `MAX_DEFERS` - Must be a positive integer
- `MAX_ABORTS` - Must be a positive integer
- `FORCE_TIMEOUT_SECONDS` - Must be a positive integer
- `MAX_LOG_SIZE_MB` - Must be a positive integer
- `REBOOT_DELAY` - Must be a positive integer

**Boolean Values:**
- All feature toggles (TEST_MODE, DEBUG_MODE, etc.)
- Automatically converted from JSON true/false to bash values

### Validation Behavior

If an invalid value is detected:
1. **Warning logged** to `/var/log/erase-install-wrapper.log`
2. **Fallback to default** value automatically
3. **Script continues** running (no crash)

**Example Log Output:**
```
[CONFIG] WARNING: INSTALLER_OS (abc) is not a valid number, using default: 15
[CONFIG] WARNING: MAX_DEFERS (-1) is not valid, using default: 3
```

### View Validation Results

Use `--show-config` to verify which values were applied:

```bash
sudo /Library/Management/erase-install/erase-install-defer-wrapper.sh --show-config
```

This displays the final configuration after validation, showing exactly what values the script will use.

---

## Jamf Pro Deployment

### Method 1: Files and Processes Payload (Recommended)

This method deploys the JSON file directly to the Mac.

#### Step 1: Create Configuration Profile

1. Go to **Computers → Configuration Profiles → New**
2. **General Tab:**
   - Display Name: `macOS Upgrade Wrapper Configuration`
   - Distribution Method: `Install Automatically`
   - Level: `Computer Level`

#### Step 2: Add Files and Processes Payload

1. Click **Files and Processes**
2. Click **Configure**
3. Click **Add** under "Files to Deploy"
4. Configure file deployment:
   ```
   File: [Upload com.macjediwizard.eraseinstall.config.json]
   Destination Path: /Library/Managed Preferences/
   File Permissions: 644
   File Owner: root
   File Group: wheel
   ```

#### Step 3: Scope and Save

1. **Scope Tab:**
   - Target: `All Computers` or specific Smart Group
2. Click **Save**

---

### Method 2: Script Deployment (Alternative)

If you prefer to manage JSON in Jamf Scripts section:

```bash
#!/bin/bash
# Jamf Script: Deploy JSON Configuration

cat > /Library/Managed\ Preferences/com.macjediwizard.eraseinstall.config.json <<'EOF'
{
  "core_settings": {
    "INSTALLER_OS": "15",
    "MAX_DEFERS": 3,
    "FORCE_TIMEOUT_SECONDS": 259200
  },
  "feature_toggles": {
    "TEST_MODE": false,
    "DEBUG_MODE": false
  },
  "main_dialog": {
    "DIALOG_TITLE": "macOS Upgrade Required",
    "DIALOG_MESSAGE": "Please install macOS {{INSTALLER_OS}}. Select an action:"
  }
}
EOF

# Set permissions
chmod 644 /Library/Managed\ Preferences/com.macjediwizard.eraseinstall.config.json
chown root:wheel /Library/Managed\ Preferences/com.macjediwizard.eraseinstall.config.json

echo "✅ JSON configuration deployed successfully"
```

---

## Example Configurations

### Standard Production Environment

```json
{
  "core_settings": {
    "INSTALLER_OS": "15",
    "MAX_DEFERS": 3,
    "FORCE_TIMEOUT_SECONDS": 259200
  },
  "feature_toggles": {
    "TEST_MODE": false,
    "DEBUG_MODE": false,
    "AUTO_INSTALL_DEPENDENCIES": true
  },
  "main_dialog": {
    "DIALOG_TITLE": "macOS Sequoia Upgrade Required",
    "DIALOG_MESSAGE": "IT requires all Macs to upgrade to macOS 15. Please select an action:"
  }
}
```

### IT Department (Aggressive)

```json
{
  "core_settings": {
    "INSTALLER_OS": "15",
    "MAX_DEFERS": 1,
    "FORCE_TIMEOUT_SECONDS": 86400
  },
  "main_dialog": {
    "DIALOG_TITLE": "⚠️ URGENT: Security Update Required",
    "DIALOG_DEFER_TEXT": "Defer 24 Hours (1 remaining)"
  },
  "abort_button": {
    "MAX_ABORTS": 1
  }
}
```

### QA/Testing Environment

```json
{
  "core_settings": {
    "INSTALLER_OS": "15",
    "MAX_DEFERS": 99
  },
  "feature_toggles": {
    "TEST_MODE": true,
    "SKIP_OS_VERSION_CHECK": true,
    "DEBUG_MODE": true,
    "PREVENT_ALL_REBOOTS": true
  },
  "main_dialog": {
    "DIALOG_TITLE": "[QA TEST] macOS Upgrade"
  }
}
```

---

## Per-Department Deployment Strategy

### Scenario: Different Settings for Different Groups

**Configuration Profile 1: IT Early Adopters**
- Name: `macOS Upgrade Config - IT Department`
- Scope: Smart Group "Department - IT"
- JSON: Aggressive settings (1 defer, 24-hour timeout)

**Configuration Profile 2: Finance (Conservative)**
- Name: `macOS Upgrade Config - Finance`
- Scope: Smart Group "Department - Finance"
- JSON: Flexible settings (5 defers, 7-day timeout)

**Configuration Profile 3: Standard Users**
- Name: `macOS Upgrade Config - Standard`
- Scope: All Computers (Exclude IT, Finance)
- JSON: Standard settings (3 defers, 3-day timeout)

---

## Testing JSON Configuration

### Validation Script

Save as `/tmp/validate-json-config.sh`:

```bash
#!/bin/bash

echo "=== JSON Configuration Validation ==="
echo ""

CONFIG="/Library/Managed Preferences/com.macjediwizard.eraseinstall.config.json"

# Check if file exists
if [ ! -f "$CONFIG" ]; then
    echo "❌ Configuration file not found: $CONFIG"
    exit 1
fi

echo "✅ Configuration file found"
echo ""

# Validate JSON syntax
if plutil -lint "$CONFIG" > /dev/null 2>&1; then
    echo "✅ JSON syntax valid"
else
    echo "❌ JSON syntax invalid"
    exit 1
fi

echo ""
echo "=== Configuration Values ==="

# Read key settings
echo "INSTALLER_OS: $(plutil -extract core_settings.INSTALLER_OS raw "$CONFIG" 2>/dev/null)"
echo "MAX_DEFERS: $(plutil -extract core_settings.MAX_DEFERS raw "$CONFIG" 2>/dev/null)"
echo "TEST_MODE: $(plutil -extract feature_toggles.TEST_MODE raw "$CONFIG" 2>/dev/null)"
echo "DEBUG_MODE: $(plutil -extract feature_toggles.DEBUG_MODE raw "$CONFIG" 2>/dev/null)"
echo "DIALOG_TITLE: $(plutil -extract main_dialog.DIALOG_TITLE raw "$CONFIG" 2>/dev/null)"

echo ""
echo "=== File Permissions ==="
ls -lh "$CONFIG"

echo ""
echo "=== Validation Complete ==="
```

Run:
```bash
sudo bash /tmp/validate-json-config.sh
```

---

## Editing JSON in Jamf

### Quick Settings Changes

1. **Computers → Configuration Profiles**
2. Find: `macOS Upgrade Wrapper Configuration`
3. Click **Edit**
4. **Files and Processes → Edit File**
5. Edit JSON directly in Jamf's text editor:
   ```json
   "MAX_DEFERS": 2   ← Change from 3 to 2
   ```
6. Click **Save**

**Result:** All scoped Macs receive updated JSON on next check-in (15-30 minutes)

---

## Troubleshooting

### Quick Diagnostics

**Use `--show-config` to see what configuration is being loaded:**

```bash
sudo /Library/Management/erase-install/erase-install-defer-wrapper.sh --show-config
```

This displays:
- Configuration source (Custom/Managed/Local/Defaults)
- All critical settings
- File paths
- Feature toggles

### JSON Not Loading

```bash
# Check which config file exists
ls -la /Library/Managed\ Preferences/com.macjediwizard.eraseinstall.config.json
ls -la /Library/Preferences/com.macjediwizard.eraseinstall.config.json

# Validate JSON syntax
plutil -lint /Library/Managed\ Preferences/com.macjediwizard.eraseinstall.config.json

# Check wrapper log
tail -50 /var/log/erase-install-wrapper.log | grep -i "configuration"

# Use --show-config to verify which config loaded
sudo /Library/Management/erase-install/erase-install-defer-wrapper.sh --show-config
```

### Wrong Values Applied

```bash
# Show current configuration
sudo /Library/Management/erase-install/erase-install-defer-wrapper.sh --show-config

# Extract specific value from JSON
plutil -extract core_settings.INSTALLER_OS raw /Library/Managed\ Preferences/com.macjediwizard.eraseinstall.config.json

# View entire JSON
plutil -p /Library/Managed\ Preferences/com.macjediwizard.eraseinstall.config.json

# Test with custom config to isolate issue
sudo /Library/Management/erase-install/erase-install-defer-wrapper.sh --config=/tmp/test.json --show-config
```

### Force Configuration Update

```bash
# Re-run Jamf check-in
sudo jamf policy

# Verify file updated
stat /Library/Managed\ Preferences/com.macjediwizard.eraseinstall.config.json
```

---

## Migration from v1.7.x

### Zero-Impact Migration

1. Deploy v2.0 wrapper WITHOUT JSON config
2. Wrapper uses hardcoded defaults (identical to v1.7.x)
3. Test with small group
4. Deploy JSON config to enable centralized management

### Complete Migration

1. Document current wrapper settings
2. Create JSON config matching current settings
3. Deploy JSON to test group
4. Deploy v2.0 wrapper to same test group
5. Verify configuration loading
6. Expand to production

---

## Benefits Summary

| Feature | v1.7.x | v2.0 JSON |
|---------|--------|-----------|
| Change Settings | Edit script, rebuild, redeploy | Edit JSON in Jamf |
| Time to Update | Hours/days | 15-30 minutes |
| Per-Department | Separate packages | Separate JSON configs |
| Audit Trail | None | Jamf change log |
| Readability | Bash variables | Structured JSON |
| Testing | Rebuild for each test | Edit JSON on-the-fly |

---

## v2.0 Development Roadmap

### Phase 1: Core Implementation (Week 1)
- [ ] Create dev branch: `v2.0-dev`
- [ ] Implement `load_json_config()` function
- [ ] Replace User Configuration Section with function call
- [ ] Add JSON validation and error handling

### Phase 2: Testing (Week 2)
- [ ] Test with JSON config (managed)
- [ ] Test without JSON config (fallback to defaults)
- [ ] Test per-department scenarios
- [ ] Test all dialog variations

### Phase 3: Documentation (Week 3)
- [ ] Update README with JSON config instructions
- [ ] Create Jamf deployment guides
- [ ] Document migration from v1.7.x
- [ ] Create troubleshooting guide

### Phase 4: Release (Week 4)
- [ ] Merge `v2.0-dev` to `main`
- [ ] Tag v2.0.0 release
- [ ] Upload JSON config to GitHub releases
- [ ] Announce release

---

**Made with ❤️ by MacJediWizard Consulting, Inc.**
