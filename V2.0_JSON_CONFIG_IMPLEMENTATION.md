# v2.0 JSON Configuration Implementation Guide

## Overview

Version 2.0 introduces **JSON-based configuration management** via Jamf Pro, allowing you to control all wrapper settings without modifying or redeploying the script.

## Why JSON?

- ✅ **Human-readable** - Easy to read and edit
- ✅ **Jamf-friendly** - Edit directly in Jamf's text interface
- ✅ **Version control** - Track changes in Jamf's audit log
- ✅ **Industry standard** - Familiar format for all admins
- ✅ **Structured** - Organized by category (dialogs, features, paths)

---

## Architecture

### Configuration File Location

```
/Library/Managed Preferences/com.macjediwizard.eraseinstall.config.json
```

### Loading Priority

1. **Managed JSON** (Jamf Configuration Profile) - highest priority
2. **Local JSON** (`/Library/Preferences/...`) - medium priority
3. **Script Defaults** (hardcoded in wrapper) - fallback

---

## Wrapper Script Integration

### New Function: load_json_config()

This function will be added to the wrapper script:

```bash
#######################################
# Load configuration from JSON file with fallback to defaults
# Globals:
#   All configuration variables
# Arguments:
#   None
# Returns:
#   0 on success, 1 if using defaults
#######################################
load_json_config() {
    local managed_json="/Library/Managed Preferences/com.macjediwizard.eraseinstall.config.json"
    local local_json="/Library/Preferences/com.macjediwizard.eraseinstall.config.json"
    local config_file=""
    local config_source="script defaults"

    # Check for managed configuration (Jamf deployed)
    if [ -f "$managed_json" ]; then
        config_file="$managed_json"
        config_source="managed configuration (Jamf)"
        log_info "Found managed JSON configuration: $managed_json"
    # Check for local configuration
    elif [ -f "$local_json" ]; then
        config_file="$local_json"
        config_source="local configuration"
        log_info "Found local JSON configuration: $local_json"
    else
        log_info "No JSON configuration found, using script defaults"
        return 1
    fi

    # Helper function to read JSON value with plutil
    read_json() {
        local json_path="$1"
        local default_value="$2"
        local value=""

        # Use plutil to extract value (native macOS tool, no dependencies)
        value=$(plutil -extract "$json_path" raw "$config_file" 2>/dev/null || echo "")

        # If extraction failed or empty, use default
        if [ -z "$value" ]; then
            echo "$default_value"
        else
            echo "$value"
        fi
    }

    # Load Core Settings
    INSTALLER_OS=$(read_json "core_settings.INSTALLER_OS" "15")
    MAX_DEFERS=$(read_json "core_settings.MAX_DEFERS" "3")
    FORCE_TIMEOUT_SECONDS=$(read_json "core_settings.FORCE_TIMEOUT_SECONDS" "259200")

    # Load File Paths
    PLIST=$(read_json "file_paths.PLIST" "/Library/Preferences/com.macjediwizard.eraseinstall.plist")
    SCRIPT_PATH=$(read_json "file_paths.SCRIPT_PATH" "/Library/Management/erase-install/erase-install.sh")
    DIALOG_BIN=$(read_json "file_paths.DIALOG_BIN" "/Library/Management/erase-install/Dialog.app/Contents/MacOS/Dialog")
    LAUNCHDAEMON_LABEL=$(read_json "file_paths.LAUNCHDAEMON_LABEL" "com.macjediwizard.eraseinstall.schedule")
    LAUNCHDAEMON_PATH=$(read_json "file_paths.LAUNCHDAEMON_PATH" "/Library/LaunchDaemons/${LAUNCHDAEMON_LABEL}.plist")

    # Load Feature Toggles
    TEST_MODE=$(read_json "feature_toggles.TEST_MODE" "false")
    PREVENT_ALL_REBOOTS=$(read_json "feature_toggles.PREVENT_ALL_REBOOTS" "false")
    SKIP_OS_VERSION_CHECK=$(read_json "feature_toggles.SKIP_OS_VERSION_CHECK" "false")
    AUTO_INSTALL_DEPENDENCIES=$(read_json "feature_toggles.AUTO_INSTALL_DEPENDENCIES" "true")
    DEBUG_MODE=$(read_json "feature_toggles.DEBUG_MODE" "false")

    # Load Logging Configuration
    MAX_LOG_SIZE_MB=$(read_json "logging.MAX_LOG_SIZE_MB" "10")
    MAX_LOG_FILES=$(read_json "logging.MAX_LOG_FILES" "5")

    # Load Main Dialog Settings
    DIALOG_TITLE=$(read_json "main_dialog.DIALOG_TITLE" "macOS Upgrade Required")
    DIALOG_TITLE_TEST_MODE=$(read_json "main_dialog.DIALOG_TITLE_TEST_MODE" "macOS Upgrade Required\n                (TEST MODE)")
    DIALOG_MESSAGE=$(read_json "main_dialog.DIALOG_MESSAGE" "Please install macOS ${INSTALLER_OS}. Select an action:")
    DIALOG_ICON=$(read_json "main_dialog.DIALOG_ICON" "SF=gear,weight=bold,size=128")
    DIALOG_POSITION=$(read_json "main_dialog.DIALOG_POSITION" "topright")
    DIALOG_HEIGHT=$(read_json "main_dialog.DIALOG_HEIGHT" "250")
    DIALOG_WIDTH=$(read_json "main_dialog.DIALOG_WIDTH" "650")
    DIALOG_MESSAGEFONT=$(read_json "main_dialog.DIALOG_MESSAGEFONT" "size=16")
    DIALOG_INSTALL_NOW_TEXT=$(read_json "main_dialog.DIALOG_INSTALL_NOW_TEXT" "Install Now")
    DIALOG_SCHEDULE_TODAY_TEXT=$(read_json "main_dialog.DIALOG_SCHEDULE_TODAY_TEXT" "Schedule Today")
    DIALOG_DEFER_TEXT=$(read_json "main_dialog.DIALOG_DEFER_TEXT" "Defer 24 Hours")
    DIALOG_DEFER_TEXT_TEST_MODE=$(read_json "main_dialog.DIALOG_DEFER_TEXT_TEST_MODE" "Defer 5 Minutes   (TEST MODE)")
    DIALOG_CONFIRM_TEXT=$(read_json "main_dialog.DIALOG_CONFIRM_TEXT" "Confirm")

    # Load Pre-installation Dialog Settings
    PREINSTALL_TITLE=$(read_json "preinstall_dialog.PREINSTALL_TITLE" "macOS Upgrade Starting")
    PREINSTALL_TITLE_TEST_MODE=$(read_json "preinstall_dialog.PREINSTALL_TITLE_TEST_MODE" "macOS Upgrade Starting\n                (TEST MODE)")
    PREINSTALL_MESSAGE=$(read_json "preinstall_dialog.PREINSTALL_MESSAGE" "Your scheduled macOS upgrade is ready to begin.\n\nThe upgrade will start automatically in 60 seconds, or click Continue to begin now.")
    PREINSTALL_PROGRESS_TEXT_MESSAGE=$(read_json "preinstall_dialog.PREINSTALL_PROGRESS_TEXT_MESSAGE" "Installation will begin in 60 seconds...")
    PREINSTALL_CONTINUE_TEXT=$(read_json "preinstall_dialog.PREINSTALL_CONTINUE_TEXT" "Continue Now")
    PREINSTALL_COUNTDOWN=$(read_json "preinstall_dialog.PREINSTALL_COUNTDOWN" "60")
    PREINSTALL_HEIGHT=$(read_json "preinstall_dialog.PREINSTALL_HEIGHT" "350")
    PREINSTALL_WIDTH=$(read_json "preinstall_dialog.PREINSTALL_WIDTH" "650")
    PREINSTALL_DIALOG_MESSAGEFONT=$(read_json "preinstall_dialog.PREINSTALL_DIALOG_MESSAGEFONT" "size=16")

    # Load Scheduled Dialog Settings
    SCHEDULED_TITLE=$(read_json "scheduled_dialog.SCHEDULED_TITLE" "macOS Upgrade Scheduled")
    SCHEDULED_TITLE_TEST_MODE=$(read_json "scheduled_dialog.SCHEDULED_TITLE_TEST_MODE" "macOS Upgrade Scheduled\n                (TEST MODE)")
    SCHEDULED_MESSAGE=$(read_json "scheduled_dialog.SCHEDULED_MESSAGE" "Your scheduled macOS upgrade is ready to begin.\n\nThe upgrade will start automatically in 60 seconds,\n\n or click Continue to begin now.")
    SCHEDULED_PROGRESS_TEXT_MESSAGE=$(read_json "scheduled_dialog.SCHEDULED_PROGRESS_TEXT_MESSAGE" "Installation will begin in 60 seconds.....")
    SCHEDULED_CONTINUE_TEXT=$(read_json "scheduled_dialog.SCHEDULED_CONTINUE_TEXT" "Continue Now")
    SCHEDULED_COUNTDOWN=$(read_json "scheduled_dialog.SCHEDULED_COUNTDOWN" "60")
    SCHEDULED_HEIGHT=$(read_json "scheduled_dialog.SCHEDULED_HEIGHT" "250")
    SCHEDULED_WIDTH=$(read_json "scheduled_dialog.SCHEDULED_WIDTH" "650")
    SCHEDULED_CONTINUE_HEIGHT=$(read_json "scheduled_dialog.SCHEDULED_CONTINUE_HEIGHT" "350")
    SCHEDULED_CONTINUE_WIDTH=$(read_json "scheduled_dialog.SCHEDULED_CONTINUE_WIDTH" "750")
    SCHEDULED_DIALOG_MESSAGEFONT=$(read_json "scheduled_dialog.SCHEDULED_DIALOG_MESSAGEFONT" "size=16")

    # Load Error Dialog Settings
    ERROR_DIALOG_TITLE=$(read_json "error_dialog.ERROR_DIALOG_TITLE" "Invalid Time")
    ERROR_DIALOG_MESSAGE=$(read_json "error_dialog.ERROR_DIALOG_MESSAGE" "The selected time is invalid.\nPlease select a valid time (00:00-23:59).")
    ERROR_DIALOG_ICON=$(read_json "error_dialog.ERROR_DIALOG_ICON" "SF=exclamationmark.triangle")
    ERROR_DIALOG_HEIGHT=$(read_json "error_dialog.ERROR_DIALOG_HEIGHT" "350")
    ERROR_DIALOG_WIDTH=$(read_json "error_dialog.ERROR_DIALOG_WIDTH" "650")
    ERROR_CONTINUE_TEXT=$(read_json "error_dialog.ERROR_CONTINUE_TEXT" "OK")

    # Load erase-install Options
    REBOOT_DELAY=$(read_json "erase_install_options.REBOOT_DELAY" "60")
    REINSTALL=$(read_json "erase_install_options.REINSTALL" "true")
    NO_FS=$(read_json "erase_install_options.NO_FS" "true")
    CHECK_POWER=$(read_json "erase_install_options.CHECK_POWER" "true")
    POWER_WAIT_LIMIT=$(read_json "erase_install_options.POWER_WAIT_LIMIT" "300")
    MIN_DRIVE_SPACE=$(read_json "erase_install_options.MIN_DRIVE_SPACE" "50")
    CLEANUP_AFTER_USE=$(read_json "erase_install_options.CLEANUP_AFTER_USE" "true")

    # Load Authentication Notice Settings
    SHOW_AUTH_NOTICE=$(read_json "auth_notice.SHOW_AUTH_NOTICE" "true")
    AUTH_NOTICE_TITLE=$(read_json "auth_notice.AUTH_NOTICE_TITLE" "Admin Access Required")
    AUTH_NOTICE_TITLE_TEST_MODE=$(read_json "auth_notice.AUTH_NOTICE_TITLE_TEST_MODE" "Admin Access Required\n            (TEST MODE)")
    AUTH_NOTICE_MESSAGE=$(read_json "auth_notice.AUTH_NOTICE_MESSAGE" "You will be prompted for admin credentials to complete the macOS upgrade.\n\nIf you do not have admin access, please use Jamf Connect or Self Service to elevate your permissions before continuing.")
    AUTH_NOTICE_BUTTON=$(read_json "auth_notice.AUTH_NOTICE_BUTTON" "I'm Ready to Continue")
    AUTH_NOTICE_TIMEOUT=$(read_json "auth_notice.AUTH_NOTICE_TIMEOUT" "0")
    AUTH_NOTICE_ICON=$(read_json "auth_notice.AUTH_NOTICE_ICON" "SF=lock.shield")
    AUTH_NOTICE_HEIGHT=$(read_json "auth_notice.AUTH_NOTICE_HEIGHT" "300")
    AUTH_NOTICE_WIDTH=$(read_json "auth_notice.AUTH_NOTICE_WIDTH" "750")

    # Load Abort Button Settings
    ENABLE_ABORT_BUTTON=$(read_json "abort_button.ENABLE_ABORT_BUTTON" "true")
    ABORT_BUTTON_TEXT=$(read_json "abort_button.ABORT_BUTTON_TEXT" "Abort (Emergency)")
    ABORT_DEFER_MINUTES=$(read_json "abort_button.ABORT_DEFER_MINUTES" "5")
    MAX_ABORTS=$(read_json "abort_button.MAX_ABORTS" "3")
    ABORT_COUNTDOWN=$(read_json "abort_button.ABORT_COUNTDOWN" "15")
    ABORT_HEIGHT=$(read_json "abort_button.ABORT_HEIGHT" "250")
    ABORT_WIDTH=$(read_json "abort_button.ABORT_WIDTH" "750")
    ABORT_ICON=$(read_json "abort_button.ABORT_ICON" "SF=exclamationmark.triangle")

    # Log configuration summary
    log_info "=== Configuration loaded from: $config_source ==="
    log_info "Target macOS Version: ${INSTALLER_OS}"
    log_info "Max Deferrals: ${MAX_DEFERS}"
    log_info "Max Aborts: ${MAX_ABORTS}"
    log_info "Test Mode: ${TEST_MODE}"
    log_info "Debug Mode: ${DEBUG_MODE}"

    return 0
}
```

### Integration in Main Script

```bash
# Early in main() function, replace User Configuration Section
main() {
    # Load configuration (JSON or defaults)
    load_json_config

    # Continue with rest of script...
}
```

---

## Jamf Pro Deployment

### Method 1: Files and Processes Payload (Recommended)

This method deploys the JSON file directly to the Mac.

#### Step 1: Create Configuration Profile

1. Go to **Computers → Configuration Profiles → New**
2. **General Tab:**
   - Display Name: `macOS Upgrade Wrapper Configuration`
   - Distribution Method: `Install Automatically`
   - Level: `Computer Level`

#### Step 2: Add Files and Processes Payload

1. Click **Files and Processes**
2. Click **Configure**
3. Click **Add** under "Files to Deploy"
4. Configure file deployment:
   ```
   File: [Upload com.macjediwizard.eraseinstall.config.json]
   Destination Path: /Library/Managed Preferences/
   File Permissions: 644
   File Owner: root
   File Group: wheel
   ```

#### Step 3: Scope and Save

1. **Scope Tab:**
   - Target: `All Computers` or specific Smart Group
2. Click **Save**

---

### Method 2: Script Deployment (Alternative)

If you prefer to manage JSON in Jamf Scripts section:

```bash
#!/bin/bash
# Jamf Script: Deploy JSON Configuration

cat > /Library/Managed\ Preferences/com.macjediwizard.eraseinstall.config.json <<'EOF'
{
  "core_settings": {
    "INSTALLER_OS": "15",
    "MAX_DEFERS": 3,
    "FORCE_TIMEOUT_SECONDS": 259200
  },
  "feature_toggles": {
    "TEST_MODE": false,
    "DEBUG_MODE": false
  },
  "main_dialog": {
    "DIALOG_TITLE": "macOS Upgrade Required",
    "DIALOG_MESSAGE": "Please install macOS {{INSTALLER_OS}}. Select an action:"
  }
}
EOF

# Set permissions
chmod 644 /Library/Managed\ Preferences/com.macjediwizard.eraseinstall.config.json
chown root:wheel /Library/Managed\ Preferences/com.macjediwizard.eraseinstall.config.json

echo "✅ JSON configuration deployed successfully"
```

---

## Example Configurations

### Standard Production Environment

```json
{
  "core_settings": {
    "INSTALLER_OS": "15",
    "MAX_DEFERS": 3,
    "FORCE_TIMEOUT_SECONDS": 259200
  },
  "feature_toggles": {
    "TEST_MODE": false,
    "DEBUG_MODE": false,
    "AUTO_INSTALL_DEPENDENCIES": true
  },
  "main_dialog": {
    "DIALOG_TITLE": "macOS Sequoia Upgrade Required",
    "DIALOG_MESSAGE": "IT requires all Macs to upgrade to macOS 15. Please select an action:"
  }
}
```

### IT Department (Aggressive)

```json
{
  "core_settings": {
    "INSTALLER_OS": "15",
    "MAX_DEFERS": 1,
    "FORCE_TIMEOUT_SECONDS": 86400
  },
  "main_dialog": {
    "DIALOG_TITLE": "⚠️ URGENT: Security Update Required",
    "DIALOG_DEFER_TEXT": "Defer 24 Hours (1 remaining)"
  },
  "abort_button": {
    "MAX_ABORTS": 1
  }
}
```

### QA/Testing Environment

```json
{
  "core_settings": {
    "INSTALLER_OS": "15",
    "MAX_DEFERS": 99
  },
  "feature_toggles": {
    "TEST_MODE": true,
    "SKIP_OS_VERSION_CHECK": true,
    "DEBUG_MODE": true,
    "PREVENT_ALL_REBOOTS": true
  },
  "main_dialog": {
    "DIALOG_TITLE": "[QA TEST] macOS Upgrade"
  }
}
```

---

## Per-Department Deployment Strategy

### Scenario: Different Settings for Different Groups

**Configuration Profile 1: IT Early Adopters**
- Name: `macOS Upgrade Config - IT Department`
- Scope: Smart Group "Department - IT"
- JSON: Aggressive settings (1 defer, 24-hour timeout)

**Configuration Profile 2: Finance (Conservative)**
- Name: `macOS Upgrade Config - Finance`
- Scope: Smart Group "Department - Finance"
- JSON: Flexible settings (5 defers, 7-day timeout)

**Configuration Profile 3: Standard Users**
- Name: `macOS Upgrade Config - Standard`
- Scope: All Computers (Exclude IT, Finance)
- JSON: Standard settings (3 defers, 3-day timeout)

---

## Testing JSON Configuration

### Validation Script

Save as `/tmp/validate-json-config.sh`:

```bash
#!/bin/bash

echo "=== JSON Configuration Validation ==="
echo ""

CONFIG="/Library/Managed Preferences/com.macjediwizard.eraseinstall.config.json"

# Check if file exists
if [ ! -f "$CONFIG" ]; then
    echo "❌ Configuration file not found: $CONFIG"
    exit 1
fi

echo "✅ Configuration file found"
echo ""

# Validate JSON syntax
if plutil -lint "$CONFIG" > /dev/null 2>&1; then
    echo "✅ JSON syntax valid"
else
    echo "❌ JSON syntax invalid"
    exit 1
fi

echo ""
echo "=== Configuration Values ==="

# Read key settings
echo "INSTALLER_OS: $(plutil -extract core_settings.INSTALLER_OS raw "$CONFIG" 2>/dev/null)"
echo "MAX_DEFERS: $(plutil -extract core_settings.MAX_DEFERS raw "$CONFIG" 2>/dev/null)"
echo "TEST_MODE: $(plutil -extract feature_toggles.TEST_MODE raw "$CONFIG" 2>/dev/null)"
echo "DEBUG_MODE: $(plutil -extract feature_toggles.DEBUG_MODE raw "$CONFIG" 2>/dev/null)"
echo "DIALOG_TITLE: $(plutil -extract main_dialog.DIALOG_TITLE raw "$CONFIG" 2>/dev/null)"

echo ""
echo "=== File Permissions ==="
ls -lh "$CONFIG"

echo ""
echo "=== Validation Complete ==="
```

Run:
```bash
sudo bash /tmp/validate-json-config.sh
```

---

## Editing JSON in Jamf

### Quick Settings Changes

1. **Computers → Configuration Profiles**
2. Find: `macOS Upgrade Wrapper Configuration`
3. Click **Edit**
4. **Files and Processes → Edit File**
5. Edit JSON directly in Jamf's text editor:
   ```json
   "MAX_DEFERS": 2   ← Change from 3 to 2
   ```
6. Click **Save**

**Result:** All scoped Macs receive updated JSON on next check-in (15-30 minutes)

---

## Troubleshooting

### JSON Not Loading

```bash
# Check file exists
ls -la /Library/Managed\ Preferences/com.macjediwizard.eraseinstall.config.json

# Validate JSON syntax
plutil -lint /Library/Managed\ Preferences/com.macjediwizard.eraseinstall.config.json

# Check wrapper log
tail -50 /var/log/erase-install-wrapper.log | grep -i "configuration"
```

### Wrong Values Applied

```bash
# Extract specific value
plutil -extract core_settings.INSTALLER_OS raw /Library/Managed\ Preferences/com.macjediwizard.eraseinstall.config.json

# View entire JSON
plutil -p /Library/Managed\ Preferences/com.macjediwizard.eraseinstall.config.json
```

### Force Configuration Update

```bash
# Re-run Jamf check-in
sudo jamf policy

# Verify file updated
stat /Library/Managed\ Preferences/com.macjediwizard.eraseinstall.config.json
```

---

## Migration from v1.7.x

### Zero-Impact Migration

1. Deploy v2.0 wrapper WITHOUT JSON config
2. Wrapper uses hardcoded defaults (identical to v1.7.x)
3. Test with small group
4. Deploy JSON config to enable centralized management

### Complete Migration

1. Document current wrapper settings
2. Create JSON config matching current settings
3. Deploy JSON to test group
4. Deploy v2.0 wrapper to same test group
5. Verify configuration loading
6. Expand to production

---

## Benefits Summary

| Feature | v1.7.x | v2.0 JSON |
|---------|--------|-----------|
| Change Settings | Edit script, rebuild, redeploy | Edit JSON in Jamf |
| Time to Update | Hours/days | 15-30 minutes |
| Per-Department | Separate packages | Separate JSON configs |
| Audit Trail | None | Jamf change log |
| Readability | Bash variables | Structured JSON |
| Testing | Rebuild for each test | Edit JSON on-the-fly |

---

## v2.0 Development Roadmap

### Phase 1: Core Implementation (Week 1)
- [ ] Create dev branch: `v2.0-dev`
- [ ] Implement `load_json_config()` function
- [ ] Replace User Configuration Section with function call
- [ ] Add JSON validation and error handling

### Phase 2: Testing (Week 2)
- [ ] Test with JSON config (managed)
- [ ] Test without JSON config (fallback to defaults)
- [ ] Test per-department scenarios
- [ ] Test all dialog variations

### Phase 3: Documentation (Week 3)
- [ ] Update README with JSON config instructions
- [ ] Create Jamf deployment guides
- [ ] Document migration from v1.7.x
- [ ] Create troubleshooting guide

### Phase 4: Release (Week 4)
- [ ] Merge `v2.0-dev` to `main`
- [ ] Tag v2.0.0 release
- [ ] Upload JSON config to GitHub releases
- [ ] Announce release

---

**Made with ❤️ by MacJediWizard Consulting, Inc.**
